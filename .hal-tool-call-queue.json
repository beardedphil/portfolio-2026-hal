[
  {
    "tool": "insert_qa_artifact",
    "params": {
      "ticketId": "0093",
      "title": "QA report for ticket 0093",
      "body_md": "# QA Report for ticket 0093\n\n## Ticket & Deliverable\n\n**Goal**: Update the QA agent instruction set so QA automatically fails a ticket when required implementation artifacts are missing and records a clear failure message on the ticket explaining what is missing.\n\n**Deliverable**: When a QA agent starts/executes QA on a ticket that lacks the required implementation artifacts, the ticket is visibly marked as QA Fail and a QA comment/message is added to the ticket detailing which required artifacts were missing.\n\n**Acceptance Criteria**:\n- [x] The QA agent instruction set explicitly lists the required implementation artifacts that must be present on a ticket before QA can pass.\n- [x] When a QA agent runs on a ticket and detects one or more required artifacts are missing, it records a QA Fail outcome (without attempting to \"guess\"/recreate the missing artifacts).\n- [x] On this auto-fail, the QA agent adds a visible message/comment to the ticket stating that QA failed due to missing implementation artifacts.\n- [x] The message enumerates the specific missing artifacts (not just a generic failure).\n- [x] The message is visible to humans and to future agents when they open the ticket.\n- [x] If all required artifacts are present, QA proceeds normally (no auto-fail message is added).\n\n## Audit Artifacts\n\nAll required implementation artifacts are present in Supabase:\n- ✅ Plan artifact\n- ✅ Worklog artifact\n- ✅ Changed Files artifact\n- ✅ Decisions artifact\n- ✅ Verification artifact\n- ✅ PM Review artifact\n\n## Code Review\n\n**PASS** - Implementation correctly addresses all acceptance criteria.\n\n### Implementation Analysis\n\n#### 1. QA agent instruction set explicitly lists required artifacts\n\n**Evidence**:\n- `.cursor/rules/qa-audit-report.mdc` lines 28-38 explicitly list all 6 required implementation artifacts:\n  1. Plan artifact\n  2. Worklog artifact\n  3. Changed Files artifact\n  4. Decisions artifact\n  5. Verification artifact\n  6. PM Review artifact\n- Each artifact includes the `artifactType` and title format specification\n\n**Code location**: `.cursor/rules/qa-audit-report.mdc:32-38`\n\n#### 2. Auto-fail when artifacts are missing\n\n**Evidence**:\n- Lines 59-66 in `qa-audit-report.mdc` explicitly state:\n  - QA **must fail immediately** if any required artifact is missing\n  - **Do NOT** attempt code review, verification, or any other QA work\n  - **Do NOT** attempt to \"guess\" or recreate missing artifacts\n  - Record a QA Fail outcome by storing a QA report\n\n**Code location**: `.cursor/rules/qa-audit-report.mdc:59-66`\n\n#### 3. Visible failure message on ticket\n\n**Evidence**:\n- Line 65 requires storing QA report in Supabase using `insert_qa_artifact` tool\n- Line 63 requires the QA report to clearly state the failure reason\n- Example QA report format (lines 68-94) shows the structure for missing artifacts\n\n**Code locations**:\n- `.cursor/rules/qa-audit-report.mdc:63-65` - Requirement to store QA report\n- `.cursor/rules/qa-audit-report.mdc:68-94` - Example format\n\n#### 4. Message enumerates specific missing artifacts\n\n**Evidence**:\n- Line 64 explicitly states: \"The QA report must enumerate the specific missing artifacts (not just a generic 'artifacts missing' message)\"\n- Example report (lines 79-87) shows specific enumeration:\n  - Missing artifacts listed with specific titles\n  - Present artifacts also listed for clarity\n\n**Code location**: `.cursor/rules/qa-audit-report.mdc:64, 79-87`\n\n#### 5. Message visible to humans and future agents\n\n**Evidence**:\n- Line 65 requires storing QA report in Supabase using `insert_qa_artifact` tool\n- Artifacts are stored in `agent_artifacts` table (line 100)\n- QA reports are linked to tickets via `ticket_pk` in Supabase\n- Future agents can fetch artifacts using `get_artifacts` tool\n\n**Code locations**:\n- `.cursor/rules/qa-audit-report.mdc:65, 100` - Storage in Supabase\n- `api/agent-tools/execute.ts:306-347` - `get_artifacts` implementation\n\n#### 6. QA proceeds normally if all artifacts present\n\n**Evidence**:\n- Line 96 states: \"If all required artifacts are present: Proceed with normal QA workflow (code review, verification, etc.)\"\n- QA report structure (lines 105-112) includes conditional sections:\n  - \"Missing Required Implementation Artifacts\" only if applicable\n  - \"Audit artifacts\" section only if all artifacts are present\n  - Code review and UI verification only if artifacts are present\n\n**Code location**: `.cursor/rules/qa-audit-report.mdc:96, 105-112`\n\n### Supporting Implementation\n\n#### get_artifacts tool\n\n**Evidence**:\n- New `getArtifacts` function added to `api/agent-tools/execute.ts` (lines 306-347)\n- Fetches all artifacts for a ticket from Supabase `agent_artifacts` table\n- Returns artifact array with fields: `artifact_id`, `ticket_pk`, `agent_type`, `title`, `body_md`, `created_at`\n- Handles both repo-scoped (ticket_number) and legacy (id) ticket lookup\n- Proper error handling for invalid ticket IDs, missing tickets, and Supabase errors\n\n**Code location**: `api/agent-tools/execute.ts:306-347`\n\n#### QA agent prompt updates\n\n**Evidence**:\n- `api/qa-agent/run.ts` updated to include `get_artifacts` tool in prompt (lines 194-197)\n- Explicitly states: \"**MUST use this tool FIRST** to check for required implementation artifacts before proceeding with QA\"\n- Tool documentation includes params and return format\n\n**Code location**: `api/qa-agent/run.ts:194-197`\n\n#### Documentation updates\n\n**Evidence**:\n- `.cursor/rules/agent-supabase-api-paradigm.mdc` updated with:\n  - `get_artifacts` tool documentation (lines 127-146)\n  - Updated QA agent requirements (lines 240-245) to include artifact checking\n- `.cursor/rules/qa-audit-report.mdc` updated with:\n  - Complete section on required implementation artifacts (lines 28-96)\n  - Auto-fail instructions with example (lines 59-94)\n  - Updated QA report structure (lines 105-112)\n\n**Code locations**:\n- `.cursor/rules/agent-supabase-api-paradigm.mdc:127-146, 240-245`\n- `.cursor/rules/qa-audit-report.mdc:28-112`\n\n### Code Review Results\n\n| Requirement | Implementation | Status |\n|------------|----------------|--------|\n| QA instruction set lists required artifacts | ✅ Implemented | `.cursor/rules/qa-audit-report.mdc:32-38` - Explicit list of 6 required artifacts with types and title formats |\n| Auto-fail when artifacts missing | ✅ Implemented | `.cursor/rules/qa-audit-report.mdc:59-66` - Explicit instructions to fail immediately, not guess/recreate |\n| Visible failure message on ticket | ✅ Implemented | `.cursor/rules/qa-audit-report.mdc:63-65` - Requires storing QA report in Supabase via `insert_qa_artifact` |\n| Enumerate specific missing artifacts | ✅ Implemented | `.cursor/rules/qa-audit-report.mdc:64` - Explicit requirement + example showing specific enumeration |\n| Message visible to humans/future agents | ✅ Implemented | `.cursor/rules/qa-audit-report.mdc:65, 100` - Stored in Supabase `agent_artifacts` table, accessible via `get_artifacts` |\n| QA proceeds normally if all present | ✅ Implemented | `.cursor/rules/qa-audit-report.mdc:96` - Explicit instruction to proceed with normal workflow |\n\n### Code Quality\n\n- ✅ **Clear instructions**: All requirements are explicitly stated with no ambiguity\n- ✅ **Example provided**: Complete example QA report format for missing artifacts (lines 68-94)\n- ✅ **Tool implementation**: `get_artifacts` properly implemented with error handling\n- ✅ **Integration**: QA agent prompt updated to include `get_artifacts` tool\n- ✅ **Documentation**: All changes properly documented in rule files\n- ✅ **No linter errors**: Code passes linting checks\n- ✅ **Type safety**: Proper TypeScript types used throughout\n\n### Implementation Details\n\n**Required artifacts list** (`.cursor/rules/qa-audit-report.mdc:32-38`):\n- Lists all 6 required artifacts with `artifactType` and title format\n- Clear specification: `Plan for ticket <ticket-id>`, etc.\n\n**Auto-fail instructions** (`.cursor/rules/qa-audit-report.mdc:59-66`):\n- Mandatory immediate failure if any artifact missing\n- Explicit prohibition on guessing/recreating artifacts\n- Requirement to enumerate specific missing artifacts\n- Requirement to store QA report in Supabase\n- Requirement for final message format: `QA RESULT: FAIL — <ticket-id>`\n\n**get_artifacts tool** (`api/agent-tools/execute.ts:306-347`):\n- Fetches artifacts from Supabase `agent_artifacts` table\n- Handles ticket lookup by `ticket_number` (repo-scoped) or `id` (legacy)\n- Returns full artifact objects with all fields needed for checking\n- Proper error handling for all failure cases\n\n**QA agent prompt** (`api/qa-agent/run.ts:194-197`):\n- Includes `get_artifacts` tool documentation\n- Explicitly states tool must be used FIRST before proceeding\n- Clear params and return format documentation\n\n### Files Changed\n\n- `.cursor/rules/qa-audit-report.mdc`:\n  - Added \"Required implementation artifacts\" section (lines 28-96)\n  - Added auto-fail instructions with example (lines 59-94)\n  - Updated QA report structure (lines 105-112)\n- `.cursor/rules/agent-supabase-api-paradigm.mdc`:\n  - Added `get_artifacts` tool documentation (lines 127-146)\n  - Updated QA agent requirements (lines 240-245)\n- `api/agent-tools/execute.ts`:\n  - Added `getArtifacts` function (lines 306-347)\n  - Added `get_artifacts` case to tool handler (lines 463-472)\n  - Updated error message to include `get_artifacts` (lines 379, 477)\n- `api/qa-agent/run.ts`:\n  - Added `get_artifacts` tool to prompt (lines 194-197)\n\n## UI Verification\n\n### Automated Checks\n\n- ✅ **Code review**: Implementation correctly adds auto-fail logic for missing artifacts\n- ✅ **Lint**: No linter errors found\n- ✅ **Type safety**: All types properly defined and used\n- ✅ **Documentation**: All changes properly documented in rule files\n\n### Manual Verification Required\n\nThe following manual steps should be performed by the user in the Human in the Loop phase:\n\n1. **Test Case 1: QA ticket with missing artifacts**\n   - Create a test ticket with implementation but missing some required artifacts (e.g., missing PM Review artifact)\n   - Run QA on the ticket\n   - **Expected**: \n     - QA agent checks for artifacts using `get_artifacts` tool\n     - QA fails immediately without code review\n     - QA report stored in Supabase enumerating specific missing artifacts\n     - Ticket shows QA Fail status\n     - QA report visible in ticket artifacts section\n\n2. **Test Case 2: QA ticket with all artifacts present**\n   - Create a test ticket with implementation and all required artifacts present\n   - Run QA on the ticket\n   - **Expected**: \n     - QA agent checks for artifacts using `get_artifacts` tool\n     - QA proceeds normally with code review and verification\n     - No auto-fail message added\n     - Normal QA workflow completes\n\n3. **Test Case 3: Verify artifact enumeration**\n   - QA a ticket missing multiple artifacts (e.g., Plan, PM Review)\n   - **Expected**: \n     - QA report lists specific missing artifacts: \"Plan artifact (`Plan for ticket XXXX`)\", \"PM Review artifact (`PM Review for ticket XXXX`)\"\n     - Not just generic \"artifacts missing\" message\n\n4. **Test Case 4: Verify visibility**\n   - After QA fails due to missing artifacts, open the ticket in HAL UI\n   - **Expected**: \n     - QA report visible in ticket artifacts section\n     - Report clearly states which artifacts are missing\n     - Future agents can fetch and read the QA report\n\n**Verification performed on**: `main` branch (implementation was merged to main for QA access)\n\n## Verdict\n\n**PASS (OK to merge)**\n\n### Rationale\n\n- Implementation correctly adds auto-fail logic when required implementation artifacts are missing\n- QA agent instruction set explicitly lists all 6 required artifacts\n- Auto-fail instructions are clear and explicit (no guessing/recreating)\n- Failure messages enumerate specific missing artifacts (not generic)\n- QA reports are stored in Supabase, making them visible to humans and future agents\n- Normal QA workflow proceeds when all artifacts are present\n- `get_artifacts` tool properly implemented with error handling\n- QA agent prompt updated to include artifact checking\n- All documentation properly updated\n- Code follows established patterns and is well-integrated\n- No code quality issues detected (no linter errors, proper error handling, type safety)\n\n### Blocking Issues\n\nNone. The implementation is ready for user verification in the Human in the Loop phase.\n\n### Recommendations\n\n1. User should verify all test cases in the UI to confirm:\n   - Auto-fail works when artifacts are missing\n   - Specific artifact enumeration in failure messages\n   - QA reports are visible in ticket artifacts section\n   - Normal QA workflow proceeds when all artifacts are present\n2. Verify that `get_artifacts` tool works correctly for both repo-scoped and legacy tickets\n3. Monitor QA agent behavior to ensure agents follow the new instructions correctly"
    }
  },
  {
    "tool": "move_ticket_column",
    "params": {
      "ticketId": "0093",
      "columnId": "col-human-in-the-loop"
    }
  }
]
