---
description: Cloud agents must pull from main before starting work; do not assume latest code
alwaysApply: true
---

# Cloud Agents: Pull from Main Before Starting

**MANDATORY:** Cloud agents (Implementation and QA) **MUST** pull the latest code from `main` before starting any work. Do not assume you have the latest code.

## Required first step

Before making changes, running tests, or loading instructions:

```bash
git checkout main && git pull origin main
```

- **Implementation agents:** Then follow the "Implementation Agent Branch Setup" section below to create/switch to your feature branch, push it immediately with upstream tracking, and verify upstream is set **before** reading files or making any code edits.
- **QA agents:** Then proceed with loading instructions and QA workflow.

## Implementation Agent Branch Setup

**MANDATORY:** Implementation agents **MUST** create or switch to the feature branch and push it immediately with upstream tracking **before** reading files or making any code edits. This ensures work is never done on an untracked local branch.

### Step 1: Create or Switch to Feature Branch

Determine your feature branch name from the ticket (typically `ticket/<id>-<short-title-kebab>` format, e.g., `ticket/0817-add-a-rule-to-create-and-push-branch-early`).

**If the branch does not exist:**
```bash
git switch -c ticket/0817-add-a-rule-to-create-and-push-branch-early
# OR (if using older git versions)
git checkout -b ticket/0817-add-a-rule-to-create-and-push-branch-early
```

**If the branch already exists:**
```bash
git switch ticket/0817-add-a-rule-to-create-and-push-branch-early
# OR (if using older git versions)
git checkout ticket/0817-add-a-rule-to-create-and-push-branch-early
```

### Step 2: Push Branch with Upstream Tracking

**MANDATORY:** Push the branch immediately with upstream tracking (`-u` flag):

```bash
git push -u origin ticket/0817-add-a-rule-to-create-and-push-branch-early
```

**If the branch already exists and upstream is missing:**
If you switched to an existing branch that doesn't have upstream tracking set, run the same push command:
```bash
git push -u origin ticket/0817-add-a-rule-to-create-and-push-branch-early
```

This will set the upstream tracking even if the branch already exists remotely.

### Step 3: Verify Upstream is Set

**MANDATORY:** Verify that upstream tracking is correctly configured:

```bash
git rev-parse --abbrev-ref --symbolic-full-name @{u}
```

**Expected output:** The command should output something like:
```
origin/ticket/0817-add-a-rule-to-create-and-push-branch-early
```

**If the command fails or outputs nothing:** The upstream is not set. Re-run `git push -u origin <branch-name>` and verify again.

### Why Push Early?

Pushing the branch immediately (before any code edits) ensures:
- **Remote backup:** Work is backed up remotely, preventing loss if the local branch is reset or the environment is lost
- **CI/PR integration:** Enables continuous integration and pull request workflows to run from the start
- **Collaboration:** Other agents or team members can access the branch if needed
- **Work safety:** Prevents losing work if the local branch is accidentally deleted or reset

**CRITICAL:** Do not proceed with reading files or making code edits until the branch is created, pushed with upstream tracking, and upstream verification succeeds.

## Never Work on Detached HEAD or Wrong Branch

**MANDATORY:** Agents must **never** perform work on detached HEAD or a non-ticket branch. All work must be performed on the correct feature branch for the ticket.

### If You Discover Work on the Wrong Branch

If you discover that work has landed on the wrong branch (detached HEAD, `main`, or a different feature branch), you **MUST** immediately fix this:

1. **Identify the commit hash(es)** of the work that was done on the wrong branch:
   ```bash
   git log --oneline -5  # Find the commit hash(es) to move
   ```

2. **Create or checkout the correct feature branch:**
   ```bash
   git checkout -b <ticket-branch>  # If branch doesn't exist
   # OR
   git switch <ticket-branch>       # If branch already exists
   ```

3. **Cherry-pick the commit(s) to the correct branch:**
   ```bash
   git cherry-pick <commit-hash>
   # If multiple commits, cherry-pick each one or use a range:
   git cherry-pick <first-hash>^..<last-hash>
   ```

4. **Push the corrected branch:**
   ```bash
   git push -u origin <ticket-branch>
   ```

5. **If work was already committed on the wrong branch, you may need to reset that branch:**
   ```bash
   # Only if you need to remove commits from the wrong branch
   git checkout <wrong-branch>
   git reset --hard <commit-before-wrong-work>
   git push --force origin <wrong-branch>  # Use with caution
   ```

**CRITICAL:** Do not continue working until the branch situation is corrected. All commits must be on the correct feature branch for the ticket.

## Why

Cloud agents run in an environment that may have cloned the repo earlier or from a different ref. The board and tickets reflect the current state of `main`; working from a stale clone can cause merge conflicts, duplicate work, or missed changes. Always start from an up-to-date `main`.

## Scope

- Applies to: implementation-agent, qa-agent (any agent that runs as a Cursor Cloud Agent on the repo).
- When: Before any other work on the ticket (first step after the agent starts).
