---
description: Cloud agents must pull from main before starting work; do not assume latest code
alwaysApply: true
---

# Cloud Agents: Pull from Main Before Starting

**MANDATORY:** Cloud agents (Implementation and QA) **MUST** pull the latest code from `main` before starting any work. Do not assume you have the latest code.

## Required first step

Before making changes, running tests, or loading instructions:

```bash
git checkout main && git pull origin main
```

- **Implementation agents:** Then follow the "Implementation Agent Branch Setup" section below.
- **QA agents:** Then proceed with loading instructions and QA workflow.

## Implementation Agent Branch Setup

**MANDATORY:** Implementation agents **MUST** create or switch to the feature branch and push it with upstream tracking **BEFORE** reading any files or making any code edits. This ensures work is never done on an untracked local branch.

### Step 1: Create or Switch to Feature Branch

Create a new branch using the ticket number and a descriptive name, or switch to an existing branch:

```bash
git switch -c ticket/0817-add-a-rule-to-create-and-push-branch-early
```

**If the branch already exists locally or remotely:**
```bash
git switch ticket/0817-add-a-rule-to-create-and-push-branch-early
```

### Step 2: Push Branch with Upstream Tracking

**MANDATORY:** Push the branch immediately with upstream tracking:

```bash
git push -u origin ticket/0817-add-a-rule-to-create-and-push-branch-early
```

**If upstream is already set but you want to ensure it's correct:**
```bash
git push -u origin ticket/0817-add-a-rule-to-create-and-push-branch-early
```

This command will set the upstream tracking relationship if it doesn't exist, or update it if it does.

### Step 3: Verify Upstream is Set

**MANDATORY:** Verify that upstream tracking is correctly configured:

```bash
git rev-parse --abbrev-ref --symbolic-full-name @{u}
```

**Expected output:**
```
origin/ticket/0817-add-a-rule-to-create-and-push-branch-early
```

If this command outputs the expected remote branch name, upstream tracking is correctly set. If it fails or outputs something unexpected, the upstream is not set correctly and you must run `git push -u origin <branch-name>` again.

### Why Push Early

Pushing the branch immediately after creation (before any code edits) provides several critical benefits:

- **Remote backup:** Work is backed up to the remote repository from the start, preventing loss if the local environment is reset or lost
- **CI/PR integration:** Enables continuous integration systems and pull request workflows to run from the first commit
- **Collaboration:** Other team members can see the branch exists and track progress
- **Safety:** Prevents losing work if the local branch is accidentally reset or deleted

### Safe Alternative: Branch Already Exists

If the branch already exists (either locally or remotely), use this safe workflow:

1. **Switch to the existing branch:**
   ```bash
   git switch ticket/0817-add-a-rule-to-create-and-push-branch-early
   ```

2. **Verify or set upstream tracking:**
   ```bash
   git push -u origin ticket/0817-add-a-rule-to-create-and-push-branch-early
   ```

3. **Verify upstream is set:**
   ```bash
   git rev-parse --abbrev-ref --symbolic-full-name @{u}
   ```

This ensures upstream tracking is configured even if the branch existed before you started work.

### Critical Ordering

**DO NOT** read files, make code edits, or run any other commands until:
1. ✅ You have pulled latest from `main`
2. ✅ You have created/switched to the feature branch
3. ✅ You have pushed the branch with upstream tracking (`git push -u origin <branch-name>`)
4. ✅ You have verified upstream is set (`git rev-parse --abbrev-ref --symbolic-full-name @{u}`)

Only after all four steps are complete should you proceed with reading files, making code changes, or any other implementation work.

## Never Work on Detached HEAD or Wrong Branch

**MANDATORY:** Agents must **never** perform work on detached HEAD or a non-ticket branch. All work must be performed on the correct feature branch for the ticket.

## Do Not

**MANDATORY:** The following destructive git commands are **prohibited by default** and must **never** be used unless explicitly required by the ticket:

- `git reset --hard` — Discards all uncommitted changes and resets the working directory to a specific commit
- `git clean -fd` — Removes untracked files and directories
- Force-push operations (`git push --force` or `git push --force-with-lease`) — Overwrites remote branch history

### Exception: When Ticket Explicitly Requires Destructive Commands

Destructive commands are **only allowed** when **both** of the following conditions are met:

1. **The ticket explicitly requires the destructive command** — The ticket description, acceptance criteria, or instructions must clearly state that a destructive command is needed (e.g., "reset the branch to a clean state" or "force-push to fix branch history").

2. **The agent creates a backup and documents the rationale** — Before executing any destructive command, the agent **MUST**:
   - Create a backup using one of the following methods:
     - **Patch file:** `git diff > backup.patch` (for uncommitted changes)
     - **Stash:** `git stash push -m "backup before destructive operation"` (for uncommitted changes)
     - **Branch backup:** `git branch backup-<timestamp>` (for committed work that might be lost)
   - Document the rationale in the worklog or decisions artifact, explaining:
     - Why the destructive command is necessary
     - What backup was created and where it is stored
     - What will be lost and why it's acceptable

**If a destructive command is needed but the ticket doesn't explicitly require it:** The agent must **not** execute the command. Instead, the agent should document the situation and request clarification or create a follow-up ticket.

### If You Discover Work on the Wrong Branch

If you discover that work has landed on the wrong branch (detached HEAD, `main`, or a different feature branch), you **MUST** immediately fix this:

1. **Identify the commit hash(es)** of the work that was done on the wrong branch:
   ```bash
   git log --oneline -5  # Find the commit hash(es) to move
   ```

2. **Create or checkout the correct feature branch:**
   ```bash
   git checkout -b <ticket-branch>  # If branch doesn't exist
   # OR
   git switch <ticket-branch>       # If branch already exists
   ```

3. **Cherry-pick the commit(s) to the correct branch:**
   ```bash
   git cherry-pick <commit-hash>
   # If multiple commits, cherry-pick each one or use a range:
   git cherry-pick <first-hash>^..<last-hash>
   ```

4. **Push the corrected branch:**
   ```bash
   git push -u origin <ticket-branch>
   ```

5. **If work was already committed on the wrong branch, you may need to reset that branch:**
   
   **WARNING:** This step involves destructive commands (`git reset --hard` and `git push --force`). See the "Do Not" section above for requirements.
   
   **Before proceeding:** Ensure you have created a backup branch of the work that will be removed:
   ```bash
   git branch backup-<wrong-branch>-<timestamp>  # Create backup before destructive operations
   ```
   
   **Only if you need to remove commits from the wrong branch:**
   ```bash
   git checkout <wrong-branch>
   git reset --hard <commit-before-wrong-work>
   git push --force origin <wrong-branch>  # Use with caution - see "Do Not" section
   ```
   
   **Documentation required:** Document in your worklog or decisions artifact:
   - Why the reset and force-push were necessary
   - What backup branch was created
   - What commits were removed and why

**CRITICAL:** Do not continue working until the branch situation is corrected. All commits must be on the correct feature branch for the ticket.

## Why

Cloud agents run in an environment that may have cloned the repo earlier or from a different ref. The board and tickets reflect the current state of `main`; working from a stale clone can cause merge conflicts, duplicate work, or missed changes. Always start from an up-to-date `main`.

## Integrity checks (pre-PR + post-PR)

**MANDATORY:** Before opening or merging a PR, agents **MUST** perform two integrity checks and include the results in the PR description.

### Pre-PR check: Branch commit count

Run the following command to verify your branch is ahead of `main`:

```bash
git rev-list --count main..HEAD
```

This should return a positive number (N commits ahead). If it returns `0`, your branch is not ahead of `main` and you need to:
- Rebase or merge `main` into your branch: `git rebase main` or `git merge main`
- Ensure your changes are committed and pushed
- Re-run the check until it shows a positive number

### Post-PR check: Changed files verification

After opening the PR, verify that the PR's "Files changed" view shows at least one changed file. If the PR shows 0 changed files:
- **STOP** — Do not merge the PR
- Investigate why no files are showing as changed
- Check that your commits were pushed correctly
- Verify the branch is correctly targeting `main`
- Only proceed after confirming the PR shows changed files

### PR description template

Include the following in your PR description (copy/paste-ready):

```markdown
## Integrity Checks

- [ ] Branch is ahead of `main` by N commits: `git rev-list --count main..HEAD` = [paste numeric result here]
- [ ] PR shows changed files: [paste confirmation statement here, e.g., "PR Files changed view shows X files modified"]
```

**Example:**
```markdown
## Integrity Checks

- [ ] Branch is ahead of `main` by N commits: `git rev-list --count main..HEAD` = 3
- [ ] PR shows changed files: PR Files changed view shows 2 files modified (cloud-agents-pull-from-main.mdc, README.md)
```

### Failure handling

- **If commit count is 0:** Rebase/merge `main` into your branch, ensure changes are committed, and re-check before opening/merging the PR.
- **If PR shows 0 changed files:** Stop immediately, investigate the issue, and do not merge until the PR correctly shows changed files.

## Scope

- Applies to: implementation-agent, qa-agent (any agent that runs as a Cursor Cloud Agent on the repo).
- When: Before any other work on the ticket (first step after the agent starts), and before opening/merging PRs (integrity checks).
