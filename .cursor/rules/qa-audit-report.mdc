---
description: QA agents must store QA reports in Supabase via HAL API
alwaysApply: true
---

# QA Audit Report (QA Agents)

When you **QA a ticket** (verify, check a ticket that is allegedly complete), store a QA report via HAL API. See `docs/process/hal-tool-call-contract.mdc` for endpoints.

## Branch to use

- **If ticket states "merged to main for QA access":** Verify from `main`. Do not use feature branch. Record in report that verification was on `main`. **No merge needed** (already on main).
- **Otherwise:** Use feature branch from ticket. **MANDATORY:** If QA passes, you **MUST** merge the feature branch to `main` and delete the branch before completing QA. If QA fails, do not merge.

## 8 required implementation artifacts (must be present before QA)

1. plan, 2. worklog, 3. changed-files, 4. decisions, 5. verification, 6. pm-review, 7. git-diff, 8. instructions-used

**Changed Files:** Must be NON-EMPTY. When files changed: list paths with brief descriptions. When no files changed: state "No files changed." with reason. Blank/empty = PROCESS FAILURE.

**How to check:** `POST ${baseUrl}/api/artifacts/get` with `{ ticketId }`. Filter `agent_type === "implementation"`. Match titles `Plan for ticket X`, etc.

**Auto-fail:** API fails, any artifact missing, or Changed Files blank → QA FAIL immediately. Store QA report, move to `col-todo`, final message: `QA RESULT: FAIL — <ticket-id>`.

## QA report structure

1. Ticket & deliverable
2. Missing artifacts (if any) — list them, then fail
3. Audit artifacts present (if all present)
4. Code review — PASS/FAIL with evidence
5. Build verification — **MANDATORY:** `npm run build:hal`; TypeScript errors = FAIL
6. Coverage — **MANDATORY:** Test coverage report with 4-metric table (lines/functions/branches/statements) and command used; see "Coverage section" below
7. Overcomplication — **MANDATORY:** Overcomplication signal with max lines policy, gate status, allowlist count, and top 10 largest files; see "Overcomplication section" below
8. UI verification — automated and/or manual steps
9. AC Confirmation Checklist — enumerate each AC, Met/Not met with evidence; see `ac-confirmation-checklist.mdc`
10. Verdict — PASS or FAIL

## Coverage section

**MANDATORY:** Every QA report **MUST** include a **Coverage** section with:

1. **A 4-metric table** showing overall coverage percentages:
   - Lines
   - Functions
   - Branches
   - Statements

2. **The command used** to generate the coverage numbers

**How to generate coverage:**

Run the following command to generate test coverage:

```bash
npm run test:coverage
```

This command runs vitest with coverage enabled and outputs a text summary with coverage percentages. Extract the overall coverage percentages from the output and include them in a table in the QA report.

**Coverage section format:**

```markdown
## Coverage

| Metric | Coverage |
|--------|----------|
| Lines | XX% |
| Functions | XX% |
| Branches | XX% |
| Statements | XX% |

**Command used:** `npm run test:coverage`
```

**Note:** Coverage numbers must reflect the current commit under test (not hardcoded). Run the command on the branch/commit being verified.

## Overcomplication section

**MANDATORY:** Every QA report **MUST** include an **Overcomplication** section with:

1. **Max allowed lines** — The repository's configured max-lines policy (from `.line-limit-allowlist.json`)
2. **Gate status** — Whether the line limit gate passed (`npm run check:lines` exit code)
3. **Allowlist count** — Number of files currently allowlisted in `.line-limit-allowlist.json`
4. **Top 10 largest files** — A ranked list of the 10 largest source files by line count with their line counts

**How to generate overcomplication data:**

Run the following command to generate overcomplication data:

```bash
npm run get:overcomplication
```

This command outputs JSON with the required data. Parse the JSON and include it in the QA report.

**Overcomplication section format:**

```markdown
## Overcomplication

**Max allowed lines:** 250

**Gate passed:** ✅ Yes (or ❌ No)

**Allowlisted files:** 35

**Top 10 largest source files:**

| Rank | File | Lines |
|------|------|-------|
| 1 | src/App.tsx | 5065 |
| 2 | projects/kanban/src/App.tsx | 3929 |
| 3 | agents/src/agents/projectManager.ts | 3590 |
| 4 | api/implementation-agent/run.ts | 528 |
| 5 | api/instructions/migrate-process-docs.ts | 434 |
| 6 | api/tickets/create.ts | 420 |
| 7 | api/agent-runs/launch.ts | 404 |
| 8 | api/tickets/move.ts | 379 |
| 9 | scripts/migrate-process-docs-to-supabase.js | 377 |
| 10 | api/process-review/create-tickets.ts | 365 |

**Command used:** `npm run get:overcomplication`
```

**Note:** Overcomplication numbers must reflect the current commit under test (not hardcoded). Run the command on the branch/commit being verified.
=======
6. UI verification — automated and/or manual steps
7. Overcomplication — **MANDATORY:** Run `node scripts/generate-overcomplication-section.js` and include the output. This section shows: max allowed lines, gate pass/fail status, count of allowlisted files, and top 10 largest source files by line count.
8. AC Confirmation Checklist — enumerate each AC, Met/Not met with evidence; see `ac-confirmation-checklist.mdc`
9. Verdict — PASS or FAIL
>>>>>>> 3ca79676b620ce71bf2d6918760cfb690775f39d

## Storing QA report

Make actual HTTP calls: `POST ${baseUrl}/api/artifacts/insert-qa` with `{ ticketId, title, body_md }`. Use `curl` or run_terminal_cmd. Do not just include JSON in your message.

## Implementation Agent Note (for FAIL verdicts)

**MANDATORY:** When a ticket fails QA (or HITL), you **MUST** create a separate, concise "Implementation agent note" artifact that explains why the ticket failed. This note is for implementation agents to quickly understand what needs to be fixed.

**Format:**
- Title: `Implementation agent note for ticket HAL-XXXX` (preferred) or `Note for implementation agent: HAL-XXXX`
- Keep it short (2-4 bullet points max)
- Focus on actionable items
- No detailed analysis—just what's wrong and what to fix
- Implementation agents are required to check for this artifact first before starting work

**Example structure:**
```markdown
# Implementation Agent Note: HAL-XXXX

## Status: FAIL

## Why This Ticket Failed

1. **Issue 1:** Brief description
2. **Issue 2:** Brief description

## Required Actions

1. Action item 1
2. Action item 2
3. Action item 3

## Code Review Notes

Brief note if implementation is otherwise correct.
```

**Store via:** `POST ${baseUrl}/api/artifacts/insert-qa` with `{ ticketId, title: "Implementation agent note for ticket HAL-XXXX", body_md }`

## Completion

- **PASS:** 
  1. Store QA report
  2. **MANDATORY:** If feature branch exists (not already on main), merge feature branch to `main` and push to remote: `git checkout main && git merge <feature-branch> && git push origin main`
     - **CRITICAL:** Both `git merge` and `git push origin main` must succeed. If either fails:
       - **Retry with exponential backoff:** Attempt up to 4 times with delays (4s, 8s, 16s, 32s)
       - **If all retries fail:** Surface the error in the final summary message and **DO NOT** move the ticket to `col-human-in-the-loop`
       - **Keep ticket in QA:** The ticket must remain in its current column (or move to `col-todo` if appropriate) until merge/push succeeds
     - **Only after confirmed successful merge + push:** Proceed to step 3
  3. **MANDATORY:** Delete feature branch (local and remote): `git branch -d <feature-branch> && git push origin --delete <feature-branch>` (only if branch exists and merge/push succeeded)
     - **CRITICAL:** Branch deletion only happens after confirmed successful merge + push. If merge/push failed, do not delete the branch.
  4. **MANDATORY:** Move ticket to `col-human-in-the-loop` **ONLY IF** merge and push both succeeded. If merge/push failed, do not move the ticket forward.
  5. Send summary. Final message must include: `QA RESULT: PASS — <ticket-id>`
     - **If merge/push failed:** Include error details in summary and state that ticket was not moved to HITL due to merge/push failure
- **FAIL:** 
  1. Store full QA report
  2. **MANDATORY:** Store Implementation agent note
  3. Move ticket to `col-todo`
  4. **Do NOT merge feature branch** (leave it for implementation agent to fix)
  5. Send summary. Final message must include: `QA RESULT: FAIL — <ticket-id>`
