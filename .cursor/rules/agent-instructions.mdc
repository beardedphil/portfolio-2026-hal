---
description: How to access agent instructions via HAL API
alwaysApply: true
---

# Agent Instructions

Agent instructions are stored in Supabase and accessed via HAL API endpoints. This file is an entry point to the instruction system.

## Accessing Instructions

### For Agents

Agents should access instructions via HAL API endpoints (preferred) or directly from Supabase (fallback).

**HAL API Endpoints:**

- **Get all instructions:** `POST /api/instructions/get`
  - Body: `{ repoFullName?: string, agentType?: string, includeBasic?: boolean, includeSituational?: boolean }`
  - Returns: List of instructions filtered by agent type and instruction type

- **Get specific topic:** `POST /api/instructions/get-topic`
  - Body: `{ topicId: string, repoFullName?: string }`
  - Returns: Full instruction content for a specific topic (used by `get_instruction_set` tool)

- **Get instruction index:** `POST /api/instructions/get-index`
  - Body: `{ repoFullName?: string }`
  - Returns: Instruction index metadata with available topics

**Example (get basic instructions):**
```javascript
const baseUrl = (await readFile('.hal/api-base-url', 'utf8')).trim()
const res = await fetch(`${baseUrl}/api/instructions/get`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    agentType: 'project-manager',
    includeBasic: true,
    includeSituational: false,
  }),
})
const result = await res.json()
if (result.success) {
  // result.instructions contains the basic instructions
}
```

**Example (get specific topic):**
```javascript
const res = await fetch(`${baseUrl}/api/instructions/get-topic`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    topicId: 'auditability-and-traceability',
  }),
})
const result = await res.json()
if (result.success) {
  // result.content contains the full instruction content
}
```

### Instruction Structure

Instructions are organized into:

1. **Basic Instructions** - Always loaded for all agents (minimal core instructions)
2. **Situational Instructions** - Available on-demand via `get_instruction_set` tool

### For Users

Users can browse and edit instructions in the HAL app:
- Click "Agent Instructions" button in the header
- Browse the instruction hierarchy (All Agents → Agent → Instruction)
- Click "Edit" to modify instructions (saves directly to Supabase)

### Instruction Storage

- **Storage:** Supabase `agent_instructions` and `agent_instruction_index` tables
- **Editing:** Via HAL app UI (writes to Supabase)
- **Access:** Via HAL API endpoints (no direct Supabase access needed)

See `.cursor/rules/agent-supabase-api-paradigm.mdc` for full API endpoint documentation.

## Moving Tickets After Implementation

**⚠️ CRITICAL MANDATORY STEP - DO NOT SKIP THIS ⚠️**

**MANDATORY:** After completing implementation work, implementation agents **MUST** move the ticket to **Ready for QA** using the HAL API. This is **not optional** - failing to move the ticket to Ready for QA means the implementation workflow is incomplete and the ticket will remain in the wrong column.

**YOU MUST MOVE THE TICKET BEFORE SENDING YOUR COMPLETION SUMMARY. DO NOT SAY "DONE" OR "COMPLETE" WITHOUT MOVING THE TICKET FIRST.**

**Move ticket to Ready for QA (REQUIRED BEFORE COMPLETION):**
```javascript
const baseUrl = (await readFile('.hal/api-base-url', 'utf8')).trim()
const res = await fetch(`${baseUrl}/api/tickets/move`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    ticketId: '0167', // The ticket ID (e.g., '0167' for HAL-0167)
    columnId: 'col-qa', // Ready for QA column
  }),
})
const result = await res.json()
if (result.success) {
  // Ticket moved successfully to position result.position
  // NOW you can send your completion summary
} else {
  // If move fails, DO NOT send completion summary - fix the issue first
  throw new Error(`Failed to move ticket: ${result.error}`)
}
```

**Ticket ID formats:**
The `/api/tickets/move` endpoint accepts multiple ticket ID formats for flexibility:
- Numeric ID: `'172'` (the actual id field value)
- With leading zeros: `'0172'` (will be normalized automatically)
- Display ID: `'HAL-0172'` (will be resolved to the numeric id)

The API automatically handles these formats by trying multiple lookup strategies, so you can use whichever format is most convenient. The API will find the ticket regardless of format and use the ticket's primary key (pk) for the update to ensure reliability.

**When to move (MANDATORY WORKFLOW):**
1. ✅ After all code changes are committed and pushed
2. ✅ After all required artifacts are stored (all 8: plan, worklog, changed-files, decisions, verification, pm-review, git-diff, instructions-used)
3. ✅ **Before moving:** Call get_artifacts (or POST /api/artifacts/get) and confirm all 8 required implementation artifacts are present with substantive content.
4. ✅ **MOVE THE TICKET TO READY FOR QA** (use the API call above)
5. ✅ **THEN** send your final "implementation complete" summary message

**If move returns success: false with missingArtifacts:** Store each listed artifact via POST /api/artifacts/insert-implementation with the corresponding artifactType, then retry POST /api/tickets/move. The move API will not allow moving to Ready for QA until all 8 artifacts are present.

**CRITICAL WORKFLOW RULE:** 
- **DO NOT** send a completion summary or "done" message without first moving the ticket to Ready for QA
- **DO NOT** mark the ticket as complete in your message if you haven't moved it
- The ticket move is **part of the completion workflow**, not an optional step
- If the move fails, **DO NOT** proceed with completion - fix the issue and retry the move (if missingArtifacts, store those artifacts then retry move)

**Available column IDs:**
- `col-unassigned` - Unassigned
- `col-todo` - To-do
- `col-doing` - Doing (Active Work)
- `col-qa` - Ready for QA
- `col-human-in-the-loop` - Human in the Loop
- `col-process-review` - Process Review
- `col-done` - Done
- `col-wont-implement` - Will Not Implement

**Note:** The HAL API endpoint `/api/tickets/move` uses server-side Supabase credentials, so agents don't need to provide credentials in the request body. The API uses the ticket's primary key (pk) for updates to ensure reliable ticket movement regardless of the ticket ID format provided.
