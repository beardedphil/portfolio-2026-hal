---
description: How to access agent instructions via HAL API
alwaysApply: true
---

# Agent Instructions

Agent instructions are stored in Supabase and accessed via HAL API endpoints. This file is an entry point to the instruction system.

## Accessing Instructions

### For Agents

Agents should access instructions via HAL API endpoints (preferred) or directly from Supabase (fallback).

**HAL API Endpoints:**

- **Get all instructions:** `POST /api/instructions/get`
  - Body: `{ repoFullName?: string, agentType?: string, includeBasic?: boolean, includeSituational?: boolean }`
  - Returns: List of instructions filtered by agent type and instruction type

- **Get specific topic:** `POST /api/instructions/get-topic`
  - Body: `{ topicId: string, repoFullName?: string }`
  - Returns: Full instruction content for a specific topic (used by `get_instruction_set` tool)

- **Get instruction index:** `POST /api/instructions/get-index`
  - Body: `{ repoFullName?: string }`
  - Returns: Instruction index metadata with available topics

**Example (get basic instructions):**
```javascript
const baseUrl = (await readFile('.hal/api-base-url', 'utf8')).trim()
const res = await fetch(`${baseUrl}/api/instructions/get`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    agentType: 'project-manager',
    includeBasic: true,
    includeSituational: false,
  }),
})
const result = await res.json()
if (result.success) {
  // result.instructions contains the basic instructions
}
```

**Example (get specific topic):**
```javascript
const res = await fetch(`${baseUrl}/api/instructions/get-topic`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    topicId: 'auditability-and-traceability',
  }),
})
const result = await res.json()
if (result.success) {
  // result.content contains the full instruction content
}
```

### Instruction Structure

Instructions are organized into:

1. **Basic Instructions** - Always loaded for all agents (minimal core instructions)
2. **Situational Instructions** - Available on-demand via `get_instruction_set` tool

### For Users

Users can browse and edit instructions in the HAL app:
- Click "Agent Instructions" button in the header
- Browse the instruction hierarchy (All Agents → Agent → Instruction)
- Click "Edit" to modify instructions (saves directly to Supabase)

### Instruction Storage

- **Storage:** Supabase `agent_instructions` and `agent_instruction_index` tables
- **Editing:** Via HAL app UI (writes to Supabase)
- **Access:** Via HAL API endpoints (no direct Supabase access needed)

See `.cursor/rules/agent-supabase-api-paradigm.mdc` for full API endpoint documentation.

## Moving Tickets After Implementation

**MANDATORY:** After completing implementation work, implementation agents **MUST** move the ticket to **Ready for QA** using the HAL API. This is **not optional** - failing to move the ticket to Ready for QA means the implementation workflow is incomplete.

**Move ticket to Ready for QA:**
```javascript
const baseUrl = (await readFile('.hal/api-base-url', 'utf8')).trim()
const res = await fetch(`${baseUrl}/api/tickets/move`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    ticketId: '0167', // The ticket ID (e.g., '0167' for HAL-0167)
    columnId: 'col-qa', // Ready for QA column
  }),
})
const result = await res.json()
if (result.success) {
  // Ticket moved successfully to position result.position
}
```

**When to move:**
- After all code changes are committed and pushed
- After all required artifacts are stored (if applicable)
- Before sending the final "implementation complete" summary message

**CRITICAL:** Do not send a completion summary or "done" message without first moving the ticket to Ready for QA. The ticket move is part of the completion workflow, not an optional step.

**Available column IDs:**
- `col-unassigned` - Unassigned
- `col-todo` - To-do
- `col-doing` - Doing (Active Work)
- `col-qa` - Ready for QA
- `col-human-in-the-loop` - Human in the Loop
- `col-process-review` - Process Review
- `col-done` - Done
- `col-wont-implement` - Will Not Implement

**Note:** The HAL API endpoint `/api/tickets/move` uses server-side Supabase credentials, so agents don't need to provide credentials in the request body.
