---
description: All agents send tool calls to HAL via JSON in messages
alwaysApply: true
---

# Agent Tool Call Contract (All Agent Types)

**MANDATORY:** All agent types (PM agents, Implementation agents, QA agents, Local Cursor agents, and future agent types) must send **tool call requests** to HAL in their messages using a simple JSON format. HAL parses these and executes them using server-side Supabase credentials.

## Contract Format

Agents send tool calls in their messages as JSON blocks:

```json
{
  "tool": "tool_name",
  "params": {
    "param1": "value1",
    "param2": "value2"
  }
}
```

HAL parses these from your message, executes them, and can respond with results. You don't need to know API URLs, make HTTP requests, or have Supabase credentials.

## Available Tools

### `insert_implementation_artifact`

Store an implementation artifact in Supabase.

**Params:**
- `ticketId` (string): Ticket ID (e.g. "0076")
- `artifactType` (string): One of "plan", "worklog", "changed-files", "decisions", "verification", "pm-review"
- `title` (string): Artifact title (e.g. "Plan for ticket 0076")
- `body_md` (string): Full markdown content of the artifact

**Example:**
```json
{
  "tool": "insert_implementation_artifact",
  "params": {
    "ticketId": "0076",
    "artifactType": "plan",
    "title": "Plan for ticket 0076",
    "body_md": "# Plan\n\n..."
  }
}
```

### `insert_qa_artifact`

Store a QA artifact in Supabase.

**Params:**
- `ticketId` (string): Ticket ID (e.g. "0076")
- `title` (string): Artifact title (e.g. "QA report for ticket 0076")
- `body_md` (string): Full markdown content of the QA report

**Example:**
```json
{
  "tool": "insert_qa_artifact",
  "params": {
    "ticketId": "0076",
    "title": "QA report for ticket 0076",
    "body_md": "# QA Report\n\n..."
  }
}
```

### `update_ticket_body`

Update a ticket's body_md in Supabase.

**Params:**
- `ticketId` (string): Ticket ID (e.g. "0076")
- `body_md` (string): Full markdown body of the ticket

**Example:**
```json
{
  "tool": "update_ticket_body",
  "params": {
    "ticketId": "0076",
    "body_md": "# Updated ticket body..."
  }
}
```

### `move_ticket_column`

Move a ticket to a different Kanban column.

**Params:**
- `ticketId` (string): Ticket ID (e.g. "0076")
- `columnId` (string): Target column ID (e.g. "col-qa", "col-human-in-the-loop", "col-todo")

**Example:**
```json
{
  "tool": "move_ticket_column",
  "params": {
    "ticketId": "0076",
    "columnId": "col-human-in-the-loop"
  }
}
```

### `get_ticket_content`

Fetch a ticket's content from Supabase.

**Params:**
- `ticketId` (string): Ticket ID (e.g. "0076")

**Example:**
```json
{
  "tool": "get_ticket_content",
  "params": {
    "ticketId": "0076"
  }
}
```

## How to Send Tool Calls

**MANDATORY:** All agents (implementation-agent, qa-agent, PM agents, local Cursor agents, cloud agents) **MUST** write tool calls to `.hal-tool-call-queue.json` in the repo root. **DO NOT** put tool calls in chat messages. HAL will check this file when tickets move columns and execute pending tool calls, then clear the queue.

### Required Method: Tool Call Queue File

**ALWAYS** write tool calls to `.hal-tool-call-queue.json` in the repo root. This is the **ONLY** method agents should use. The file format is a JSON array:

```json
[
  {
    "tool": "insert_qa_artifact",
    "params": {
      "ticketId": "0076",
      "title": "QA report for ticket 0076",
      "body_md": "# QA Report\n\n..."
    }
  },
  {
    "tool": "move_ticket_column",
    "params": {
      "ticketId": "0076",
      "columnId": "col-human-in-the-loop"
    }
  }
]
```

HAL will check this file when tickets move columns and execute all pending tool calls, then clear the queue.

**FORBIDDEN:** Do not include tool calls as JSON blocks in chat messages. Always write them to `.hal-tool-call-queue.json` instead.

### Legacy Method (Deprecated - Do Not Use)

~~**Method 1 (Preferred):** Include tool calls in your completion/summary message. HAL's `toolCallParser.ts` will parse JSON blocks from agent messages and execute them.~~

**This method is deprecated. Always use the queue file instead.**

### Old Method 2 (Deprecated - Do Not Use)

~~**Method 2 (Fallback):** Write tool calls to `.hal-tool-call-queue.json` in the repo root. HAL will check this file when tickets move columns and execute pending tool calls.~~

**This is now the ONLY method. Always use it.**

```json
[
  {
    "tool": "insert_implementation_artifact",
    "params": {
      "ticketId": "0097",
      "artifactType": "plan",
      "title": "Plan for ticket 0097",
      "body_md": "# Plan\n\n..."
    }
  },
  {
    "tool": "insert_implementation_artifact",
    "params": {
      "ticketId": "0097",
      "artifactType": "worklog",
      "title": "Worklog for ticket 0097",
      "body_md": "# Worklog\n\n..."
    }
  }
]
```

HAL will check this file when tickets move columns and execute all pending tool calls, then clear the queue.

## Benefits

1. **No API URLs needed** - Just include JSON in your message
2. **No credentials needed** - HAL uses server-side Supabase credentials
3. **Simple contract** - Easy JSON format
4. **Works everywhere** - Cloud agents, local agents, all the same
5. **HAL handles reliability** - HAL ensures Supabase operations succeed

## Implementation Agent Requirements

Implementation agents must store all required artifacts before marking ticket ready:

1. Plan artifact
2. Worklog artifact
3. Changed Files artifact
4. Decisions artifact
5. Verification artifact
6. PM Review artifact

Use `insert_implementation_artifact` for each one.

## QA Agent Requirements

QA agents must:

1. Store QA report using `insert_qa_artifact`
2. Move ticket to Human in the Loop using `move_ticket_column`

See `.cursor/rules/qa-audit-report.mdc` for full workflow.

## Documentation

See `docs/process/hal-tool-call-contract.mdc` for detailed documentation.
