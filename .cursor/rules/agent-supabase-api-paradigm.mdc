---
description: All agents send tool calls to HAL via direct API
alwaysApply: true
---

# Agent Tool Call Contract (All Agent Types)

**MANDATORY:** All agent types (PM, Implementation, QA, Local Cursor, cloud agents) must persist tool calls so HAL can execute them (artifacts, ticket moves, etc.). HAL uses server-side Supabase credentials; agents never need credentials.

## How to Send Tool Calls

### Preferred: Call HAL API directly (cloud and local)

When the repo contains **`.hal/api-base-url`**, read that file for the HAL base URL (e.g. `https://portfolio-2026-hal.vercel.app`). For **each** tool call, perform an HTTP request to the corresponding endpoint. No credentials are required in the request; the HAL server uses its own Supabase env.

**Endpoint mapping:**

| Tool | Method | Path | Request body |
|------|--------|------|--------------|
| `insert_implementation_artifact` | POST | `/api/artifacts/insert-implementation` | `{ ticketId, artifactType, title, body_md }` |
| `insert_qa_artifact` | POST | `/api/artifacts/insert-qa` | `{ ticketId, title, body_md }` |
| `update_ticket_body` | POST | `/api/tickets/update` | `{ ticketId, body_md }` |
| `move_ticket_column` | POST | `/api/tickets/move` | `{ ticketId, columnId }` |
| `get_ticket_content` | POST | `/api/tickets/get` | `{ ticketId }` |
| `get_instructions` | POST | `/api/instructions/get` | `{ repoFullName?, agentType?, includeBasic?, includeSituational? }` |
| `get_instruction_topic` | POST | `/api/instructions/get-topic` | `{ topicId, repoFullName? }` |
| `get_instruction_index` | POST | `/api/instructions/get-index` | `{ repoFullName? }` |

**Example (store plan artifact):**
```javascript
const baseUrl = (await readFile('.hal/api-base-url', 'utf8')).trim()
const res = await fetch(`${baseUrl}/api/artifacts/insert-implementation`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    ticketId: '0097',
    artifactType: 'plan',
    title: 'Plan for ticket 0097',
    body_md: '# Plan\n\n...',
  }),
})
const result = await res.json()
if (!result.success) throw new Error(result.error)
```

**Example (move ticket):**
```javascript
const res = await fetch(`${baseUrl}/api/tickets/move`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ ticketId: '0097', columnId: 'col-human-in-the-loop' }),
})
```

Call the API **immediately** when you have artifact content or a column move—do not wait for merge. This way artifacts and ticket moves appear in Supabase and on the Kanban without merging to main.

**Note:** HAL runs as an API-driven app. All tool calls must be sent via direct API calls. The `.hal/api-base-url` file must be present for agents to function properly.

## Available Tools

### `insert_implementation_artifact`

Store an implementation artifact in Supabase.

**Params:**
- `ticketId` (string): Ticket ID (e.g. "0076")
- `artifactType` (string): One of "plan", "worklog", "changed-files", "decisions", "verification", "pm-review", "git-diff", "instructions-used"
- `title` (string): Artifact title (e.g. "Plan for ticket 0076")
- `body_md` (string): Full markdown content of the artifact

**Example:**
```json
{
  "tool": "insert_implementation_artifact",
  "params": {
    "ticketId": "0076",
    "artifactType": "plan",
    "title": "Plan for ticket 0076",
    "body_md": "# Plan\n\n..."
  }
}
```

### `insert_qa_artifact`

Store a QA artifact in Supabase.

**Params:**
- `ticketId` (string): Ticket ID (e.g. "0076")
- `title` (string): Artifact title (e.g. "QA report for ticket 0076")
- `body_md` (string): Full markdown content of the QA report

**Example:**
```json
{
  "tool": "insert_qa_artifact",
  "params": {
    "ticketId": "0076",
    "title": "QA report for ticket 0076",
    "body_md": "# QA Report\n\n..."
  }
}
```

### `update_ticket_body`

Update a ticket's body_md in Supabase.

**Params:**
- `ticketId` (string): Ticket ID (e.g. "0076")
- `body_md` (string): Full markdown body of the ticket

**Example:**
```json
{
  "tool": "update_ticket_body",
  "params": {
    "ticketId": "0076",
    "body_md": "# Updated ticket body..."
  }
}
```

### `move_ticket_column`

Move a ticket to a different Kanban column.

**Params:**
- `ticketId` (string): Ticket ID (e.g. "0076")
- `columnId` (string): Target column ID (e.g. "col-qa", "col-human-in-the-loop", "col-todo")

**Example:**
```json
{
  "tool": "move_ticket_column",
  "params": {
    "ticketId": "0076",
    "columnId": "col-human-in-the-loop"
  }
}
```

### `get_ticket_content`

Fetch a ticket's content from Supabase.

**Params:**
- `ticketId` (string): Ticket ID (e.g. "0076")

**Example:**
```json
{
  "tool": "get_ticket_content",
  "params": {
    "ticketId": "0076"
  }
}
```

### `get_artifacts`

Fetch all artifacts for a ticket from Supabase.

**Params:**
- `ticketId` (string): Ticket ID (e.g. "0076")

**Returns:**
- `success` (boolean): Whether the operation succeeded
- `artifacts` (array): Array of artifact objects with fields: `artifact_id`, `ticket_pk`, `agent_type`, `title`, `body_md`, `created_at`

**Example:**
```json
{
  "tool": "get_artifacts",
  "params": {
    "ticketId": "0076"
  }
}
```

## Benefits

1. **Direct API** - Artifacts and ticket moves apply immediately without merging to main; no credentials in agent environment.
2. **No credentials needed** - HAL server uses its own Supabase credentials.
3. **API-driven workflow** - All tool calls are executed immediately via HTTP requests to HAL's API endpoints.

## Implementation Agent Requirements

Implementation agents must store all required artifacts before marking ticket ready:

1. Plan artifact
2. Worklog artifact
3. Changed Files artifact
4. Decisions artifact
5. Verification artifact
6. PM Review artifact
7. Git diff artifact
8. Instructions Used artifact

Use `insert_implementation_artifact` for each one.

## QA Agent Requirements

QA agents must:

1. **First step (MANDATORY):** Check for required implementation artifacts using HAL API endpoint `/api/artifacts/get` with `{ ticketId: "<ticket-id>" }`.
   - If `.hal/api-base-url` exists, read it and call: `POST ${baseUrl}/api/artifacts/get`
   - **If API call fails (404, 500, network error, timeout):** QA **MUST FAIL** immediately. You cannot verify artifacts exist, so treat as missing. Do NOT proceed with code review.
   - **If API call succeeds:** Filter artifacts to find implementation artifacts (`agent_type === "implementation"`) and verify all 8 required artifact types are present.
2. **Auto-fail if artifacts are missing or unverifiable** — store QA report enumerating missing artifacts (or API failure), move ticket to To-do, do NOT proceed with code review
3. **If all artifacts present:** Store QA report using `insert_qa_artifact` after completing code review and verification
4. Move ticket to Human in the Loop using `move_ticket_column` (only if QA passes)

**CRITICAL:** Artifact verification is the first and mandatory step. If you cannot verify artifacts exist (API failure), the ticket fails QA. Do not skip this step or proceed with code review when verification fails.

See `.cursor/rules/qa-audit-report.mdc` for full workflow.

## Documentation

See `docs/process/hal-tool-call-contract.mdc` for detailed documentation.
