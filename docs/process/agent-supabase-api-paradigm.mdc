# Agent Supabase API Paradigm (All Agent Types)

## Overview

**All agent types** (PM agents, Implementation agents, QA agents, Local Cursor agents, and future agent types) must interact with Supabase through **HAL's API endpoints**, not directly. This ensures:

1. **No credential management** - Agents don't need Supabase credentials in their environment
2. **Centralized access** - All Supabase access goes through HAL's API
3. **Security** - Credentials stay on the server, never exposed to agents
4. **Consistency** - Same API endpoints used by HAL UI and all agents

## HAL API Base URL

- **Local development:** `http://localhost:5173`
- **Production/deployment:** Your HAL deployment URL (e.g. `https://your-domain.com`)

The API uses server-side environment variables (`SUPABASE_URL`, `SUPABASE_ANON_KEY`), so agents don't need to provide credentials in requests.

## Available API Endpoints

### Ticket Operations

- **`POST /api/tickets/get`** - Fetch ticket content
  - Body: `{ ticketId: string }`
  - Returns: `{ success: boolean, body_md?: string, error?: string }`

- **`POST /api/tickets/update`** - Update ticket body
  - Body: `{ ticketId: string, body_md: string }`
  - Returns: `{ success: boolean, error?: string }`

- **`POST /api/tickets/move`** - Move ticket to different column
  - Body: `{ ticketId: string, columnId: string }`
  - Returns: `{ success: boolean, position?: number, movedAt?: string, error?: string }`

### Artifact Operations

- **`POST /api/artifacts/insert-implementation`** - Store implementation artifact
  - Body: `{ ticketId: string, artifactType: string, title: string, body_md: string }`
  - Returns: `{ success: boolean, artifact_id?: string, action?: 'inserted' | 'updated', error?: string }`
  - `artifactType` values: `"plan"`, `"worklog"`, `"changed-files"`, `"decisions"`, `"verification"`, `"pm-review"`

- **`POST /api/artifacts/insert-qa`** - Store QA artifact
  - Body: `{ ticketId: string, title: string, body_md: string }`
  - Returns: `{ success: boolean, artifact_id?: string, action?: 'inserted' | 'updated', error?: string }`

## Agent Type Requirements

### PM Agents

PM agents running through HAL's agent system (in `projects/hal-agents/src/agents/projectManager.ts`) currently have direct Supabase access via tools. **Future:** These tools should be updated to use HAL API endpoints for consistency, but they can continue using direct Supabase access if credentials are available (for backward compatibility).

**For cloud PM agents or agents without direct Supabase access:** Use HAL API endpoints:
- `POST /api/tickets/get` - Fetch ticket content
- `POST /api/tickets/update` - Update ticket body
- `POST /api/tickets/move` - Move ticket columns

### Implementation Agents

Implementation agents (both cloud and local) must use HAL API endpoints:

1. **Fetch ticket:** `POST /api/tickets/get`
2. **Store artifacts:** `POST /api/artifacts/insert-implementation` for each artifact type:
   - Plan
   - Worklog
   - Changed Files
   - Decisions
   - Verification
   - PM Review
3. **Update ticket:** `POST /api/tickets/update` (e.g. to add branch name)
4. **Move ticket:** `POST /api/tickets/move` (if needed)

**Implementation agent prompts** should instruct agents to use HAL API endpoints. The Cursor Cloud Agents API implementation should be updated to include HAL API URL in the prompt.

### QA Agents

QA agents must use HAL API endpoints:

1. **Fetch ticket:** `POST /api/tickets/get`
2. **Store QA report:** `POST /api/artifacts/insert-qa`
3. **Update ticket:** `POST /api/tickets/update` (if needed)
4. **Move ticket:** `POST /api/tickets/move` (to Human in the Loop)

**QA agent prompts** should instruct agents to use HAL API endpoints. See `.cursor/rules/qa-audit-report.mdc` for full workflow.

### Local Cursor Agents

Local Cursor agents (running in Cursor IDE) must use HAL API endpoints:

- Determine HAL API URL (typically `http://localhost:5173` if HAL is running locally)
- Use all API endpoints as documented above
- No Supabase credentials needed in local environment

### Future Agent Types

Any new agent types must follow this paradigm:
- Use HAL API endpoints for all Supabase operations
- Do not access Supabase directly
- Do not require Supabase credentials in agent environment

## Example: Storing Implementation Artifacts

```typescript
// Store Plan artifact
const response = await fetch('http://localhost:5173/api/artifacts/insert-implementation', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    ticketId: '0076',
    artifactType: 'plan',
    title: 'Plan for ticket 0076',
    body_md: '# Plan\n\n...',
  }),
})

const result = await response.json()
if (result.success) {
  console.log('Artifact stored:', result.artifact_id)
}
```

## Example: Moving Ticket to Human in the Loop

```typescript
const response = await fetch('http://localhost:5173/api/tickets/move', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    ticketId: '0076',
    columnId: 'col-human-in-the-loop',
  }),
})

const result = await response.json()
if (result.success) {
  console.log('Ticket moved to position:', result.position)
}
```

## Error Handling

All API endpoints return:
- `{ success: true, ... }` on success
- `{ success: false, error: string }` on failure

Always check `result.success` before proceeding. If `success` is `false`, log the error and handle appropriately.

## Benefits

1. **No credential management** - Agents don't need `.env` files or Supabase credentials
2. **Works in cloud environments** - Cloud agents can call HAL API without local credentials
3. **Centralized access** - All Supabase operations go through HAL's API
4. **Consistent across all agent types** - Same API for PM, Implementation, QA, and future agents
5. **Security** - Credentials stay on HAL's server, never exposed to agents

## Migration Notes

- **Existing PM agent tools:** Can continue using direct Supabase access if credentials are available (backward compatibility)
- **New implementations:** Must use HAL API endpoints
- **Cloud agents:** Must use HAL API endpoints (no direct Supabase access available)
- **Local agents:** Should use HAL API endpoints for consistency
